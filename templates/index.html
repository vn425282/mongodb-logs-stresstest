<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Stress Test Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
        }
        /* Custom styles for the toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        /* Custom scrollbar for the log panel */
        #log-panel::-webkit-scrollbar {
            width: 8px;
        }
        #log-panel::-webkit-scrollbar-track {
            background: #2d3748;
        }
        #log-panel::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 10px;
            border: 2px solid #2d3748;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Log Stress Test Service</h1>
            <p class="mt-2 text-gray-500">Configure and run a high-volume log generation test against your database.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Configuration -->
            <div id="config-card" class="bg-gray-50 p-6 rounded-xl border border-gray-200 space-y-6">
                <h2 class="text-xl font-bold text-gray-700 border-b pb-2">1. Configuration</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-600">Duration (seconds)</label>
                        <input type="number" id="duration" value="60" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label for="workers" class="block text-sm font-medium text-gray-600">Workers (concurrency)</label>
                        <input type="number" id="workers" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label for="batch_size" class="block text-sm font-medium text-gray-600">Batch Size</label>
                        <input type="number" id="batch_size" value="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label for="distribution" class="block text-sm font-medium text-gray-600">Distribution (optional)</label>
                        <input type="text" id="distribution" placeholder="log_type_1:50,log_type_2:50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">MongoDB Target</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="mdb_uri" class="block text-sm font-medium text-gray-600">Connection URI</label>
                            <input type="text" id="mdb_uri" placeholder="mongodb+srv://user:pass@cluster..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="mdb_db" class="block text-sm font-medium text-gray-600">Database</label>
                                <input type="text" id="mdb_db" value="logs" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="mdb_collection" class="block text-sm font-medium text-gray-600">Collection</label>
                                <input type="text" id="mdb_collection" value="stress_test" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                        </div>
                        <button id="test-connection-btn" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm transition duration-150 ease-in-out">
                            Test Connection
                        </button>
                        <p id="connection-status" class="text-sm text-center mt-2 h-4"></p>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">2. Log Templates</h3>
                    <!-- NEW: Test Mode Toggle Switch -->
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border">
                        <span class="text-sm font-medium text-gray-700">Test Mode: <span id="mode-label">Upload Files</span></span>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="mode-toggle" id="mode-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    
                    <!-- NEW: Dropdown for Hardcoded Mode -->
                    <div id="hardcoded-options" class="mt-4 hidden">
                         <label for="hardcoded-select" class="block text-sm font-medium text-gray-600">Select Hardcoded Test Type</label>
                         <select id="hardcoded-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="simple">Simple Logs (Max Speed)</option>
                            <option value="complex">Complex Logs (Schema-based)</option>
                            <option value="mixed">Mixed Logs (4 Types)</option>
                         </select>
                    </div>

                    <!-- Existing Upload Area -->
                    <div id="upload-area" class="mt-4 p-6 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-indigo-500 transition">
                        <p class="text-gray-500">
                            <span class="font-semibold text-indigo-600">Upload files</span> or drag and drop
                        </p>
                        <p class="text-xs text-gray-400 mt-1">.txt and .json files supported</p>
                        <input id="file-upload" type="file" multiple class="hidden">
                    </div>
                    <ul id="file-list" class="mt-2 text-sm text-gray-600 list-disc list-inside"></ul>
                </div>
            </div>

            <!-- Right Column: Monitor & Control -->
            <div id="monitor-card" class="bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col">
                <h2 class="text-xl font-bold text-gray-700 border-b pb-2">3. Monitor & Control</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <button id="start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">Start Test</button>
                    <button id="stop-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-sm transition duration-150 ease-in-out" disabled>Stop Test</button>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Live Progress</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-center text-sm text-gray-500 mt-1">Waiting to start...</p>
                </div>

                <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div class="bg-white p-4 rounded-lg border">
                        <p class="text-sm text-gray-500">Event Rate</p>
                        <p id="event-rate" class="text-2xl font-bold text-indigo-600">0 <span class="text-lg font-medium text-gray-400">events/sec</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <p class="text-sm text-gray-500">Total Events Sent</p>
                        <p id="total-sent" class="text-2xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <p class="text-sm text-gray-500">Elapsed Time</p>
                        <p id="elapsed-time" class="text-2xl font-bold text-indigo-600">0s</p>
                    </div>
                </div>

                <div class="mt-6 flex-grow flex flex-col">
                     <h3 class="text-lg font-semibold text-gray-700 mb-2">System Log</h3>
                     <div id="log-panel" class="flex-grow bg-gray-800 text-white font-mono text-xs p-4 rounded-lg overflow-y-auto h-48 md:h-64">
                        <p>&gt; Waiting for test to start...</p>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let uploadedFiles = []; // Store file content

        // DOM Elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const testConnectionBtn = document.getElementById('test-connection-btn');
        const logPanel = document.getElementById('log-panel');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const eventRateEl = document.getElementById('event-rate');
        const totalSentEl = document.getElementById('total-sent');
        const elapsedTimeEl = document.getElementById('elapsed-time');
        const connectionStatusEl = document.getElementById('connection-status');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-upload');
        const fileList = document.getElementById('file-list');
        // NEW: Mode switch elements
        const modeToggle = document.getElementById('mode-toggle');
        const modeLabel = document.getElementById('mode-label');
        const hardcodedOptions = document.getElementById('hardcoded-options');
        const hardcodedSelect = document.getElementById('hardcoded-select');

        // --- Event Listeners ---
        startBtn.addEventListener('click', startTest);
        stopBtn.addEventListener('click', () => socket.emit('stop_test'));
        testConnectionBtn.addEventListener('click', testMDBConnection);
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('border-indigo-500', 'bg-indigo-50'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50'), false);
        });
        uploadArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);
        
        // NEW: Listener for the mode toggle switch
        modeToggle.addEventListener('change', () => {
            const isHardcodedMode = modeToggle.checked;
            if (isHardcodedMode) {
                modeLabel.textContent = 'Hardcoded';
                uploadArea.classList.add('hidden');
                hardcodedOptions.classList.remove('hidden');
                fileList.innerHTML = ''; // Clear file list
                uploadedFiles = [];
            } else {
                modeLabel.textContent = 'Upload Files';
                uploadArea.classList.remove('hidden');
                hardcodedOptions.classList.add('hidden');
            }
        });

        // --- Socket.IO Event Handlers ---
        socket.on('connect', () => addLog('Connected to backend server.'));
        socket.on('test_started', (data) => {
            addLog(data.message);
            setUIState(true);
        });
        socket.on('test_stopped', (data) => {
            addLog(data.message, 'yellow');
            setUIState(false);
            resetMetrics();
        });
        socket.on('test_update', (data) => {
            if (data.final) {
                addLog(`Test finished. Total events sent: ${data.total_sent}`, 'green');
                setUIState(false);
                progressBar.style.width = '100%';
                progressText.textContent = 'Test finished.';
            } else if(data.error) {
                addLog(data.error, 'red');
            } else {
                updateMetrics(data);
            }
        });
        socket.on('test_error', (data) => {
            addLog(data.error, 'red');
            setUIState(false);
        });
        socket.on('mdb_connection_result', (data) => {
            connectionStatusEl.textContent = data.message;
            connectionStatusEl.className = data.status === 'success' ? 'text-sm text-center mt-2 h-4 text-green-600' : 'text-sm text-center mt-2 h-4 text-red-600';
            addLog(`MongoDB connection ${data.status}!`, data.status === 'success' ? 'green' : 'red');
        });
         socket.on('system_log', (data) => {
            addLog(data.message, 'cyan');
        });

        // --- Main Functions ---
        function startTest() {
            const params = {
                duration: parseInt(document.getElementById('duration').value) || 60,
                workers: parseInt(document.getElementById('workers').value) || 10,
                batch_size: parseInt(document.getElementById('batch_size').value) || 100,
                distribution: document.getElementById('distribution').value,
                mdb_uri: document.getElementById('mdb_uri').value,
                mdb_db: document.getElementById('mdb_db').value,
                mdb_collection: document.getElementById('mdb_collection').value,
            };

            const payload = { params };
            
            // NEW: Logic to handle different modes
            const isHardcodedMode = modeToggle.checked;
            if (isHardcodedMode) {
                params.hardcoded_test_type = hardcodedSelect.value;
                payload.files = []; // No files needed
            } else {
                if (uploadedFiles.length === 0) {
                    addLog('Error: Please upload at least one log template file.', 'red');
                    return;
                }
                payload.files = uploadedFiles;
            }

            if (!params.mdb_uri) {
                addLog('Error: MongoDB Connection URI is required.', 'red');
                return;
            }

            resetMetrics();
            addLog('Starting test...');
            setUIState(true);
            socket.emit('start_test', payload);
        }

        function testMDBConnection() {
            const uri = document.getElementById('mdb_uri').value;
            if (!uri) {
                addLog('Please enter a MongoDB URI to test.', 'yellow');
                return;
            }
            addLog('Pinging MongoDB at ' + uri);
            connectionStatusEl.textContent = 'Pinging...';
            connectionStatusEl.className = 'text-sm text-center mt-2 h-4 text-gray-500';
            socket.emit('test_mdb_connection', { mdb_uri: uri });
        }

        function handleFiles(files) {
            uploadedFiles = []; // Reset
            fileList.innerHTML = '';
            const filePromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedFiles.push({ name: file.name, content: e.target.result });
                        const li = document.createElement('li');
                        li.textContent = file.name;
                        fileList.appendChild(li);
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            });
            Promise.all(filePromises).catch(err => {
                addLog('Error reading files: ' + err, 'red');
            });
        }
        
        // --- UI Helper Functions ---
        function setUIState(isRunning) {
            startBtn.disabled = isRunning;
            stopBtn.disabled = !isRunning;
            startBtn.classList.toggle('opacity-50', isRunning);
            startBtn.classList.toggle('cursor-not-allowed', isRunning);
            stopBtn.classList.toggle('opacity-50', !isRunning);
            stopBtn.classList.toggle('cursor-not-allowed', !isRunning);
        }

        function updateMetrics(data) {
            progressBar.style.width = `${Math.min(100, data.progress)}%`;
            progressText.textContent = `Test running... ${Math.round(data.progress)}% complete.`;
            eventRateEl.innerHTML = `${Math.round(data.rate)} <span class="text-lg font-medium text-gray-400">events/sec</span>`;
            totalSentEl.textContent = Math.round(data.total_sent).toLocaleString();
            elapsedTimeEl.textContent = `${Math.round(data.elapsed)}s`;
        }

        function resetMetrics() {
            progressBar.style.width = '0%';
            progressText.textContent = 'Waiting to start...';
            eventRateEl.innerHTML = '0 <span class="text-lg font-medium text-gray-400">events/sec</span>';
            totalSentEl.textContent = '0';
            elapsedTimeEl.textContent = '0s';
            connectionStatusEl.textContent = '';
        }

        function addLog(message, color = 'white') {
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString();
            let colorClass = 'text-gray-300';
            if (color === 'green') colorClass = 'text-green-400';
            if (color === 'red') colorClass = 'text-red-400';
            if (color === 'yellow') colorClass = 'text-yellow-400';
            if (color === 'cyan') colorClass = 'text-cyan-400';
            
            p.innerHTML = `<span class="text-gray-500">${timestamp} PM &gt;</span> <span class="${colorClass}">${message}</span>`;
            logPanel.appendChild(p);
            logPanel.scrollTop = logPanel.scrollHeight; // Auto-scroll
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
    </script>
</body>
</html>

